= Mule OAuth 2.0 Provider
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:meta-audience: Developer
:meta-job-phase: Implement
:meta-job:
:meta-exp-level: Expert
:meta-feature: oauth
:meta-keywords: oauth, oauth provider, authentication
:meta-synonym:
:meta-product: API Manager, Studio, Mule
:meta-applies-to:

Mule OAuth 2.0 Provider is an OAuth 2.0 provider alternative developed by MuleSoft that can be used in any API Platform organization (including the Federated ones).
It is the recommended initial solution pending future corporate investments in enterprise specific OAuth 2.0 offerings.

Supported third party OAuth 2.0 providers:

* PingFederate
* OpenAM
* OAuth 2.0 providers supporting Open ID Connect

The xref:external-oauth-2.0-token-validation-policy.adoc[Mule OAuth 2.0 access token enforcement policy] is designed to work with the Mule OAuth 2.0 provider.

== Getting the Mule OAuth 2.0 provider
To run the Mule OAuth 2.0 Provider you have to deploy the provider to a runtime with API Gateway capabilities (E.g. Mule runtime engine v3.x, Mule runtime engine v4.2.0 or later) with the corresponding organization credentials correctly specified.

=== Mule v3.x
You can download the OAuth Provider from Exchange.

See the https://anypoint.mulesoft.com/exchange/org.mule.templates/api-gateway-external-oauth2-provider/[External OAuth 2.0 server for Anypoint Platform] asset in Exchange to download it.

=== Mule v4.x
This feature is available from Mule v4.2.0.

See the https://anypoint.mulesoft.com/exchange/org.mule.templates/api-gateway-oauth2-provider/[Mule OAuth 2.0 server for Anypoint Platform] asset in Exchange to download it.

== OAuth 2.0 dance

The authentication process performed by the Mule OAuth 2.0 provider, API, and client application conforms to RFC 6749. This process is called the xref:oauth-dance-about.adoc[OAuth 2.0 dance].

Mule OAuth 2.0 provider supports all xref:oauth-grant-types-about.adoc[grant types].

The entity that requests access to a resource protected by Mule OAuth 2.0 access token enforcement policy is a `Client`.

=== Endpoints

image::mule-oauth-provider.png[height=150,width=250]

[%header%autowidth.spread,cols="a,a,a"]
|===
| Purpose | Default path | Description
| Token validation
| /validate
| Used to verify the validity of the token (eg. it lets you determine if the token is expired, revoked or fake). You may define more than one validation endpoint, each of them enforcing different scopes. See <<Scopes>> for more information about this.
| Authorization
| /authorize
| Used to obtain a token when the client is running in a browser using a scripting language or the client is a web server.
| Access
| /access_token
| Used when the client is owned by the same entity as the Mule OAuth 2.0 provider or when the client himself is the same entity that owns the protected resource.
| Token revocation
| /revoke
| [Optional] Used to revoke a valid token, so it becomes invalid.
|===

=== Scopes

OAuth 2.0 https://tools.ietf.org/html/rfc6749#page-23[scopes] are a way to further limit access to a resource protected by OAuth. You may define words like `READ`, `WRITE`, or some other words that make sense in the context of your organization (eg. `CONTRACTOR`, `PUBLIC`, `EMPLOYEES_ONLY`, etc).

You can define scopes in three different places:

* In the universal set definition, `defaultScopes`, where you define all possible scopes.
  Example:
+
[source,xml,linenums]
----
<oauth2-provider:config
  scopes="CONTRACTOR, PUBLIC_READ, EMPLOYEES_ONLY, WRITE"
  >
  ...
</oauth2-provider:config>
----
* In the validation endpoint, `/validate`, to enforce a particular subset of the previously defined scopes.
* In the `Mule OAuth 2.0 access token enforcement` policy, where you can enforce scopes by specifying a space-separated list.
** Specifying more than one scope, will enforce `OR` logic: If the token to be validated has associated at least one of the requested scopes, the policy will validate the token successfully.

== Example fragment using Mule v4.2.x or later

[source,xml,linenums]
----
...
    <oauth2-provider:config name="external-oauth2-provider"
    							resourceOwnerSecurityProvider="resourceOwnerSecurityProvider"
    							clientSecurityProvider="clientSecurityProvider"
    							supportedGrantTypes="AUTHORIZATION_CODE,IMPLICIT,RESOURCE_OWNER_PASSWORD_CREDENTIALS,CLIENT_CREDENTIALS"
    							listenerConfig="https.listener"
    							scopes="CONTRACTOR, PUBLIC_READ, EMPLOYEES_ONLY, WRITE"
                                defaultScopes="CONTRACTOR, PUBLIC_READ, EMPLOYEES_ONLY, WRITE"
                                clientStore="clientObjectStore">
    		<oauth2-provider:token-config path="/access-token" tokenTtl="5" tokenTtlTimeUnit="SECONDS" tokenStore="tokenObjectStore">
                <oauth2-provider:refresh-token-strategy>
                    <oauth2-provider:single-refresh-token objectStore="refreshTokenObjectStore"/>
                </oauth2-provider:refresh-token-strategy>
            </oauth2-provider:token-config>
    		<oauth2-provider:authorization-config path="/authorize" authorizationCodeStore="authorizationCodeObjectStore"/>
    	</oauth2-provider:config>

        <flow name="validateToken">
            <http:listener path="/validate" config-ref="https.listener"/>
            <oauth2-provider:validate-token scopes="#[['PUBLIC_READ']]" config-ref="external-oauth2-provider" accessToken="#[attributes.queryParams.access_token]"/>
            <error-handler>
                <on-error-continue type="OAUTH2-PROVIDER:TOKEN_UNAUTHORIZED">
                    <set-payload value="UNAUTHORIZED_TOKEN"/>
                </on-error-continue>
            </error-handler>
        </flow>
...
----

Full https://anypoint.mulesoft.com/exchange/org.mule.templates/api-gateway-oauth2-provider/[Mule OAuth 2.0 server for Anypoint Platform] asset available on Exchange.

== Token Cache

To prevent downtime of the Mule OAuth 2.0 provider due to errors when connecting to the platform,
the Mule OAuth Client Store caches each valid Client Application for which a token is requested.

If the Mule OAuth 2.0 provider requests a new token while there is no connection, the OAuth 2.0 Client Store falls back to the cache.

The expiration of its entries has a default of 30 days. Additionally, you can configure this range, and even set
it to persist the cache locally to ensure service availability in case of a restart or lack of connection to the platform. In case
a Client Application for which a token already exists in the Client Store is removed from Anypoint Platform, on the next token request,
the Client Store will remove the Client from the cache, mirroring the platform status.

=== Customizing token cache mechanism

This feature is available for Mule runtime v4.2.0 and later.

The Object Store has two configurable properties:
[%header%autowidth.spread,cols="a,a"]
|===
| `anypoint.oauth_provider.cache_persistence_enabled`
| Defines whether the caching mechanism should persist locally. The default value is `true` if the property is not set or cannot be parsed. Cache persistence allows client authorization without connection to Anypoint Platform.

| `anypoint.oauth_provider.cache_ttl_days`
| Represents how many days each Client Application should be cached by the OAuth Server. This value can be any positive floating point number. The default value is `30`, representing 30 days.
|===

== See Also
*** xref:external-oauth-2.0-token-validation-policy.adoc[Mule OAuth 2.0 Access Token Policy usage]
*** xref:oauth-dance-about.adoc[OAuth 2.0 Dance and OAuth 2.0 Access Token Enforcement]
*** xref:oauth-grant-types-about.adoc[OAuth 2.0 Grant Types]
*** xref:org-credentials-config-mule4.adoc[Setting startup credentials]
