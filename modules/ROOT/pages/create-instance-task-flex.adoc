= Adding a Flex Gateway API Instance
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:product: flex

include::partial$task-add-api-instance.adoc[tags=intro1;flex-intro;intro2]

[[add-api]]
== Add a New API

. Navigate to *Anypoint Platform* > *API Manager*.
. In *API Administration*, click *Add API* and select *Add new API*.
. Select *Flex Gateway*.
. Select a connected Flex Gateway you have installed and registered from the list under *Select a gateway*.
+
[NOTE]
--
If you do not see a Flex Gateway listed, or you see a Flex Gateway but its status is DISCONNECTED,
See xref:gateway::flex-install.adoc[Install Flex Gateway] and xref:gateway::flex-conn-reg-run.adoc[Register and Run in Connected Mode] for more information.
--

. Click *Next*.
+
include::partial$task-configure-proxy.adoc[tags=mid-steps;asset-type-options]

. Configure the downstream:
+
include::partial$api-configuration-tables.adoc[tags=flex-downstream]
. Click *Next*.
. Configure the upstream:
+
include::partial$api-configuration-tables.adoc[tags=flex-upstream]
. Click *Next*.
+
include::partial$task-configure-proxy.adoc[tags=last-steps]



== Flex Gateway Traffic Management in Connected Mode

Flex Gateway version 1.5 or later supports API instances that expose multiple upstream services through a single consumer endpoint.

Flex Gateway manages traffic by using multiple routes with defined rulesets to direct traffic to upstream services. Each API instance supports multiple routes that can each direct traffic to multiple upstream services.

In the following diagram, different routes manage requests to flight information databases and to a customer service application. Route one has two upstream services defined directing 70% of requests to a stable database and 30% of requests to a beta database.  

image:multiple-upstreams.png[]


== Routes

Each API instance supports up to 10 routes that can support up to 10 upstream services. You define what routes receive what requests by define route rules and route order.

Only one route per API instance is required. 

You can add additional routes by clicking *Add Route (optional)*, and you can delete routes by clicking the *Trash Can* icon (image:trash-can-icon.png[2%,2%]). If only one route is defined, you cannot delete that route.

=== Route Rules

You can direct requests to different routes using route rules. 

Flex Gateway supports the following route rules:

[%header%autowidth.spread,cols="15%,35%,50"]
|===
| Field Name | Description | Notes
| *Method* | The request methods supported by this route | You can specify multiple methods for each route. Only requests that are one of the specified methods are directed to this route.
| *Path* | Also known as “URI Template Regex”, path is a regular expression to match the request path. | You can only specify one path for each route. Only requests with the specified path are sent to this route.
| *Host* | The host path the request is made to | You can only specify one path for each route. Only requests with the specified path are sent to this route.
| *Headers* | The headers present or not present to direct to this route | For this rule, you must specify the header and a `true` or `false` value of whether or not it is present. Only requests that meet all the specified header requirements are sent to this route. Additional headers present in the request that are not specified in the rules are ignored. To add an additional header, click *Add header (optional)*.
|===

All rules are optional. Not specifying a rule means that the information is not used as route criteria. For example, not specifying a host means that this route can service any host as long as the request meets the other specified rules. Not specifying any rules means that the route can service every request.

Only requests that meet all specified rules defined in the ruleset are directed to that route.

To view and edit route rules, click *Route Rules*.

=== Route Order

In addition to route rules, you can direct requests to different routes by setting the route order. 

Flex Gateway directs requests to the first route where the request meets the route rules. Therefore, route ordering is very important when a request may meet the route rules of multiple routes. 

For example, in a configuration where route one has the GET method applied as a rule and route two has no route rules applied, all GET requests are sent to route one and all other requests are sent to route two. If the route was reversed and route one had not route rules, Flex Gateway would direct all requests to the route one.
 
Generally, you should order routes with more complex route rules first. If you do not set a route order, routes are ordered in the order they were defined.

To reorder routes, from the upstream configuration page:

. Click *Reorder Routes*.
. Use the up and down arrows to rearrange the route order.
. Click *Apply Order*

== Upstreams

You can use multiple upstreams in a single route to direct requests to similar services. For example, if you want to test the performance of a new beta upstream service without routing all traffic to the new service, you can route half of the traffic to the older upstream service and half to the new upstream service.

Each API instance route can support up to 10 upstream services, but At least one upstream is required for each route. 

You can add upstream by clicking *Add Upstream (optional)*, and you can delete upstreams by clicking the *Trash Can* icon (image:trash-can-icon.png[2%,2%]). If only one upstream is defined, you cannot delete that upstream.

To configure an upstream, specify the following fields:

[%header%autowidth.spread,cols="15%,35%,15%,35%"]
|===
| Field Name | Description | Required | Notes
| *Upstream URL* | The URL to access for the proxy or the API. It must end with a /. | Yes |  For example, you can use the URL of your API asset in Exchange.
| *Upstream Label* | Specifies a label for the upstream | No | If you have multiple upstream service instances, add a label to differentiate each instance from the others.
| *TLS* | Specifies the TLS Context used for the outbound traffic | No | xref:gateway::flex-conn-tls-config.adoc[Configure a TLS Context for Flex Gateway] before adding a TLS Context to your API.
| *Weight* | The percentage of requests to send to that upstream service | Yes | This value is only configurable if you have multiple upstreams. The sum of all upstream weights must equal 100%.
|===

//promote-api
include::partial$task-promote-api.adoc[]

//import-api
include::partial$task-import-api.adoc[]

== Notes

* Although OpenAPI Specification (OAS) 3.0 is supported, the callback feature is not. To work around this issue, either handle the callback outside of the Mule runtime engine domain or use an OAS 3.0 specification that does not use callbacks.