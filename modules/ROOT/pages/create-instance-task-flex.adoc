= Adding a Flex Gateway API Instance
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:product: flex

include::partial$task-add-api-instance.adoc[tags=intro1;flex-intro;intro2]

[[add-api]]
== Add a New API

. Navigate to *Anypoint Platform* > *API Manager*.
. In *API Administration*, click *Add API* and select *Add new API*.
. Select *Flex Gateway*.
. Select a connected Flex Gateway you have installed and registered from the list under *Select a gateway*.
+
[NOTE]
--
If you do not see a Flex Gateway listed, or you see a Flex Gateway but its status is DISCONNECTED,
See xref:gateway::flex-install.adoc[Install Flex Gateway] and xref:gateway::flex-conn-reg-run.adoc[Register and Run in Connected Mode] for more information.
--

. Click *Next*.
+
include::partial$task-configure-proxy.adoc[tags=mid-steps;asset-type-options]

. Configure the downstream configuration settings:
+
include::partial$api-configuration-tables.adoc[tags=flex-downstream]
. Click *Next*.
. Configure one of the following upstream configurations:
** *Single Upstream* +
If you are deploying an API instance to Flex Gateway version 1.4.x or earlier or only want to configure a single upstream service, configure the following upstream configuration settings:
+
include::partial$api-configuration-tables.adoc[tags=flex-upstream]
** *Multiple Upstreams* +
Flex Gateway version 1.5.x or later supports API instances that expose multiple upstream services through a single consumer endpoint. +
To configure multiple upstream services, see <<traffic-management>>.
. Click *Next*.
+
include::partial$task-configure-proxy.adoc[tags=last-steps]


[[traffic-management]]
== Multiple Upstreams for Flex Gateway Running in Connected Mode

Flex Gateway version 1.5.x or later supports API instances that expose multiple upstream services through a single consumer endpoint.

Flex Gateway manages traffic by using different routes with defined rulesets and route order to direct traffic to different sets of upstream services. Each API instance supports multiple routes that can each direct traffic to multiple upstream services.

In the following diagram, different routes manage requests to flight information databases and to a customer service application. Route one has two upstream services defined, which direct 70% of requests to a stable database and 30% of requests to a beta database.  

image:multiple-upstreams.png[Flex Gateway manages the traffic to multiple upstreams]

=== Routes

Each API instance supports up to 10 routes and each route can support up to 10 upstream services. You configure what routes receive what requests by defining route rules and route order. Only one route per API instance is required. 

You can add additional routes by clicking *Add Route (optional)*, and you can delete routes by clicking the *Trash Can* icon (image:trash-can-icon.png[2%,2%]). If only one route is defined, you cannot delete that route.

==== Route Rules

You can direct requests to different routes using route rules. 

To view and edit route rules, click *Route Rules*.

All rules are optional. Not defining a value for a rule means that aspect of the request not considered. For example, not specifying a host means that the route can service any host given the request meets the other route rules. Not defining any rules means that the route can service every request.

Additionally, different routes can support the same upstream services. If you cannot capture all the requests for a particular set of upstream services in a single route rule set, you can define multiple routes with different rules for full coverage.

Only requests that meet all rules defined in the ruleset are directed to that route.

Flex Gateway supports the following route rules:

Method::::
+
The *Method* rule defines the types of request methods the route can service.
+
You can select multiple methods for each route. Only requests that are one of the defined methods are directed to this route.
+
To select the supported methods:
+
. Expand the *Method* drop down list.
. Select the supported methods.
+
Path::::
+
The *Path* rule defines the request path the route can service.
+
You can only define one â€œURI Template Regex" path for each route. Only requests with the defined path are sent to this route.
+
To define the *Path* rule:
+
. Enter your path template in the *Path* configuration field.
+
Host::::
+
The *Host* rule defines the request host the route can service.
+
You can only define one host URL for each route. Only requests made from the defined host are sent to this route.
+
To define the *Host* rule:
+
. Enter your host in the *Host* configuration field.
+
Header::::
+
The *Headers* rule defines what headers are required to be present or not present for this route to service the request.
+
For this rule, you must define the header name and a `true` or `false` value of whether or not the header is present. Only requests that meet all the specified header requirements are sent to this route. Additional headers present in the request that are not specifically defined in the rules are ignored. 
+
You can define up to 10 headers.
+
To define the *Headers* rule:
+
. Click *Add header (optional)*, if this is not your first header.
. Enter the header name in the first box.
. Enter `true` or `false` dependent on if the header must be present.
+
NOTE: To delete a header. click the *Trash Can* icon (image:trash-can-icon.png[2%,2%]).  

==== Route Order

In addition to route rules, you can direct requests to different routes by defining the route order. 

Flex Gateway directs requests to the first route where the request meets the route rules. Therefore, route ordering is very important when a request may meet the route rules of multiple routes. 

For example, in a configuration where route one has the `GET` method defined as a rule and route two has no route rules defined, all `GET` requests are sent to route one and all other requests are sent to route two. If the route order was reversed and route one had no route rules, Flex Gateway would direct all requests to route one before any `GET` requests could reach route two.
 
Generally, you should order the routes with more complex route rules first. If you do not define a route order, routes are ordered in the order they were created.

To reorder routes:

. Click *Reorder Routes*.
. Use the up and down arrows to rearrange the route order.
. Click *Apply Order*

=== Upstreams

You can use multiple upstream services in a single route to direct requests to similar services. For example, if you want to test the performance of a new beta upstream service without sending all traffic to the new service, you can direct half of the traffic to a stable upstream service and half to the new upstream service.

Each API instance route can support up to 10 upstream services, but at least one upstream service is required for each route. 

What upstream service within the route each request is sent to is random and independent of any previous request. The upstream *Weight* defines the percentage chance of a request being sent to a particular upstream service.

Since any upstream service within a route could recieve any request, all upstream services within the same route must adhere to the same API contract.

You can add a upstream service by clicking *Add Upstream (optional)*, and you can delete a upstream service by clicking the *Trash Can* icon (image:trash-can-icon.png[2%,2%]). If only one upstream service is defined, you cannot delete that upstream service.

Configure the following fields for each upstream:

[%header%autowidth.spread,cols="15%,35%,15%,35%"]
|===
| Field Name | Description | Required | Notes
| *Upstream URL* | The URL to access for the proxy or the API. It must end with a /. | Yes |  For example, you can use the URL of your API asset in Exchange.
| *Upstream Label* | Specifies a label for the upstream service | No | If you have multiple upstream service instances, add a label to differentiate each instance from the others.
| *TLS* | Specifies the TLS Context used for the outbound traffic to that particular upstream service | No | xref:gateway::flex-conn-tls-config.adoc[Configure a TLS Context for Flex Gateway] before adding a TLS Context to your API.
| *Weight* | The percentage of requests to send to that upstream service | Yes | This value is only configurable if you have multiple upstream services. The sum of all upstream weights must equal `100%`.
|===



//promote-api
include::partial$task-promote-api.adoc[]

//import-api
include::partial$task-import-api.adoc[]

== Notes

* Although OpenAPI Specification (OAS) 3.0 is supported, the callback feature is not. To work around this issue, either handle the callback outside of the Mule runtime engine domain or use an OAS 3.0 specification that does not use callbacks.