= OpenID Connect OAuth 2.0 Token Enforcement Policy
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]

[width="100%", cols="5,15"]
|===
>s| Policy Name | OpenID Connect OAuth 2.0 Token Enforcement
>s|Summary      | Allows access only to authorized client applications
>s|Category | Security
>s| First Mule version available | v4.1.1
.4+>.^s| Returned Status Codes
|400 - Invalid token
|401 - Unauthorized access or error when connecting to the authorization server
|403 - Forbidden, invalid client application credentials
|500 - Bad response from authorization server, or WSDL SOAP Fault error.
|===

The OpenID Connect Access Token Enforcement policy restricts access to a protected resource to only those HTTP requests that provide a valid Oauth2 token belonging to a client application with API access. The policy does not generate tokens but only validates them. 

This policy is available only to an organization that is configured to use the OpenID Connect dynamic client registration as a xref:access-management::configure-client-management-openid-task.adoc[client-management solution]. 

[[how-this-policy-works]]
== How This Policy Works

The following diagram illustrates the OpenID Connect Access Token Enforcement policy workflow:

image:open-id-policy-workflow.png[OpenID Connect OAuth 2.0 Token Enforcement Workflow]

As shown in the diagram:

. The user first sends an HTTP request to the API protected by the policy. 
. The policy extracts the token from the request and sends it to the validation endpoint to verify the integrity of the token.
. The token validation endpoint returns token metadata, including the client ID of the client application.
. Using a local database updated with contracts that were previously obtained from Anypoint Platform, the policy verifies whether the client ID has access to the API. 
. If all the validations are successfully completed, the request is allowed to reach the backend.

[[leveraging-TVE-information]]
=== Leveraging Token Validation Endpoint Information for Mule Applications

When a token validation endpoint successfully validates a token, certain information, such as configurable fields from OpenID Connect, are returned to the policy.

The following example illustrates the token validation response from the authorization server:

[source,text,linenums]
---
{
    "uid":"john.doe",
    "mail":"john.doe@example.com"
    "token_type":"Bearer",
    "exp": 1516239022
    "alias" : ["Jhon", "Jhonny", "Mr Doe"],
    "address" : {
        "city": "london", 
        "road": “abbey road"
    }
}
---

The fields returned by the OAuth provider are processed by the policy, propagated throughout the Mule flow, and finally exposed to the backend if the application requesting the access uses an HTTP requester.

=== Token Caching

After the system validates a token, that token is cached (by default) until it expires, to improve the performance of the policy. In certain cases, such as in the case of revoked tokens, you might want to minimize or even disable caching.

To control the time taken to cache the tokens before retrying a validation against the token validation endpoint, specify the following property when starting the Mule runtime engine:

`anypoint.platform.max_federation_expiration_time=<expiration time in seconds; specify 0 to disable caching>`

Alternatively, you can specify this parameter in the `wrapper.conf` file.
 
To control the number of tokens that can be cached simultaneously, specify the following property when starting the Mule runtime engine:
 
`anypoint.platform.openid_connect_cache_max_size=<amount of tokens to be cached; default value is 10.000>`

Alternatively, you can specify this parameter in the `wrapper.conf` file.

[[token-validation-endpoint-authentication]]
=== Token Validation Endpoint Authentication

To complete validating the provided token, the policy sends a request to the validation endpoint. The policy then obtains the credentials from the client provider configuration in access management, per the Token Introspection Client section of the OAuth 2.0 Authorization Framework specification. These credentials are sent in the request body, as specified in the https://tools.ietf.org/html/rfc6749#section-2.3[Client Authentication section of the OAuth 2.0 Authorization Framework specification]. 

Other authentication methods for the token validation endpoint are currently not supported.

== Configuring the Expose Headers Option

If you configured the `Expose Headers` option in the policy and if the application (for example, out-of-the-box proxies) uses the HTTP requester, the properties are redirected to the backend as headers. 

For each field, the original request to the protected resource is enriched with the HTTP headers using the format: X-AGW- + <key>=<value>. For the example response from the previous section, the following headers are added:

[source,text,linenums]
---
X-AGW-uid=john.doe
X-AGW-mail=john.doe@example.com
X-AGW-token_type=Bearer
---

The propagated properties do not include the `scope`, and `exp` objects and arrays.

For further processing within the flow, the original unparsed response from the validation endpoint is made available. The information is stored in an authentication object. 

For example, if a `mail` field is returned to the policy, you can access the value of the field by using the following DataWeave 2.0 expression:

`#[authentication.properties.userProperties.mail]`

You can obtain the client ID of the OAuth2 token by using the following DataWeave 2.0 expression:

`#[authentication.principal]`

== Communicating with the Token Validation Endpoint Using a Proxy

You can enable the OpenID Connect OAuth 2.0 Token Enforcement policy to use the gateway proxy settings by specify the following property when starting the Mule runtime engine: 

`anypoint.platform.external_authentication_provider_enable_proxy_settings=<true|false(default)>`

When you enable this property, the policy uses the Mule proxy settings, if you have specified the following parameters:

* `anypoint.platform.proxy_host=localhost`
* `anypoint.platform.proxy_port=8080`

== Configuring Policy Parameters

When you apply the policy to your API from the UI, a list of parameters is displayed based on whether your environment includes a Mule or xref:service-mesh::index.adoc[non-Mule application managed by Anypoint Service Mesh].

=== Configuring Parameters for Mule Applications

For Mule applications, the following parameters are displayed:

[%header%autowidth.spread,cols="30,40,30"]
|===
| Element | Description | Example
| Scopes | Displays a space-separated list of supported scopes. | READ, WRITE, READ and WRITE 
| Scope Validation Criteria | Determines if the token must contain all defined scopes or just one.
Values: `Contains all scopes` and `Contains any scope` | 
If the ‘Contains all scopes’ value is selected, the tokens with the scopes `READ` and `WRITE` are accepted. If the ‘Contains any scopes’ value is selected, the tokens with the scope `READ, WRITE, and READ AND WRITE` are accepted. 
| Validate TLS Certificate | Enables third-party authentication server TLS validation. | If selected, the communication with the token validation endpoint uses the TLS protocol.
| Expose Headers | In a proxy scenario, specifies whether headers must be exposed in the request to the backend. User properties returned by the federation server are prefixed with 'X-AGW-' and sent as headers to the backend. | See the <<leveraging-TVE-information,Leveraging Token Validation Endpoint Information for Mule Applications>> for more information about this element.
| Skip Client Id Validation | Skips the client application's API contract validation. | If selected, the Step 4 of the diagram in the <<how-this-policy-works,How This Policy Works>> section is skipped.
|===

=== Configuring Parameters for Non-Mule Applications (Anypoint Service Mesh)

For non-Mule applications that are managed by Anypoint Service Mesh, the following parameters are displayed:

[%header%autowidth.spread,cols="30,40,30"]
|===
| Element | Description | Example
| Scopes | Displays a space-separated list of supported scopes. | `READ`, `WRITE`, `READ AND WRITE`
| Skip Client Id Validation | Skips the client application's API contract validation. | If selected, the Step 4 of the diagram in the <<how-this-policy-works,How This Policy Works>> section is skipped.
|===


== FAQs

*The OpenID Connect Access Token Enforcement policy does not appear in the list of policies to apply to the API.*

If the policy does not appear in the policies list, ensure that you have configured the OpenID client provider in Access Management. For information, see xref:access-management::configure-client-management-openid-task.adoc[Configure OpenID Connect Client Management]. If you are using xref:configure-multiple-credential-providers.adoc[multiple IdPs], verify that the OpenID connect client is properly configured in the API.


*Can I generate OAuth2 tokens with the policy?*

No. The policy only validates the tokens.

*OpenID Connect validation endpoint is rejecting the requests sent by the policy.*

See the validation endpoint documentation provided by the OpenID connect server and verify whether the authentication method described in the <<token-validation-endpoint-authentication,Token Validation Endpoint Authentication>> section is supported.


*How does the policy manage the credentials to communicate with the validation endpoint?*

This information is part of the policy configuration and is stored on a disk. If you want this information to be stored with encryption, xref:api-gateway-encryption-mule4.adoc[configure gateway encryption in your runtime]. 


*How are the OAuth tokens cached?*

OAuth2 tokens are cached only in memory and are never written to disk.


*Does the policy communicate with the Anypoint Platform on a per-request basis?*

No, the policy uses client applications previously retrieved by the Mule runtime engine.
This enables the policy to continue working even if the connection with the Management plane is lost. If you want the client application information that is written on disk to be encrypted, xref:api-gateway-encryption-mule4.adoc[configure gateway encryption in your runtime].


*Can I configure the Rate-Limiting SLA policy after I configure the OpenID Connect Access Token Enforcement policy?*

Yes, you can. Apply the Rate-Limiting SLA policy after the OpenID Connect Access Token Enforcement policy and provide a `Client ID Expression` value using the following DataWeave 2.0 expression: 

`#[authentication.principal]`

Because the identity of the requester is already validated by the OpenID Connect Access Token Enforcement policy, you can leave the `Client Secret Expression` field empty.

*Where can I find the information associated with the token after it has been validated?*
The information is available in the authentication object. For more information, see <<leveraging-TVE-information,Token Validation Endpoint Information for Mule Applications>>.


== See Also

* xref:api-contracts-landing-page.adoc[Client Applications and Contracts]
* xref:about-configure-api-for-oauth.adoc[OAuth 2.0 Policy Prerequisites]
* xref:oauth-dance-about.adoc[OAuth 2.0 Dance and OAuth 2.0 Access Token Enforcement]
* xref:apply-oauth-token-policy-task.adoc[Applying an OAuth 2.0 Token Validation Policy]
* xref:using-policies.adoc[Applying a Policy]
* https://openid.net/connect/[OpenID Connect] identity provider
* xref:access-management::external-identity.adoc#instructions-for-saml-configuration[SAML 2.0]
* xref:3.8@mule-runtime::mule-expression-language-mel.adoc[MEL expressions]
* xref:configure-autodiscovery-4-task.adoc[Configuring API Gateway API Autodiscovery in a Mule 4 Application]
* xref:configure-autodiscovery-3-task.adoc[Configuring API Gateway API Autodiscovery in a Mule 3 Application]
